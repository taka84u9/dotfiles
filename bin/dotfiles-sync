#!/bin/bash

warning() {
  printf "\e[33m$1\e[0m\n"
}

create_symlink() {
  file_in_dotfiles="$PWD/$1"
  file_in_home="$HOME/.$1"

  if [[ -e $file_in_home ]]; then
    if [[ ! -L $file_in_home ]]; then
      warning "$file_in_home exists but is not a symlink."
    fi
  else
    echo "Creating symlink at $file_in_home"
    ln -s "$file_in_dotfiles" "$file_in_home"
  fi
}

# Move to dotfiles root
cd "$(dirname "$BASH_SOURCE")/.."

git pull origin master || exit 1
git submodule update --init --recursive || exit 1

# Sync all files except $except
except=(
  Brewfile
  README.md
  bin
  fonts
  grc
  iterm2
  keyremap4macbook.xml
  modules
  rbenv
  script
  zsh
)
for file in *; do
  filename="$(basename "$file")"
  if [[ ! " ${except[@]} " =~ " ${filename} " ]] ; then
    create_symlink $filename
  fi
done

~/.tmux/plugins/tpm/bin/clean_plugins # Remove plugins not on the plugin list
~/.tmux/plugins/tpm/bin/install_plugins

case $OSTYPE in
darwin*)
  if [[ ! -e ~/Library/Application\ Support/iTerm2/DynamicProfiles/profile.json ]] ; then
    ln -s $DOTFILES_ROOT/iterm2/profile.json ~/Library/Application\ Support/iTerm2/DynamicProfiles/profile.json
  fi
  brew bundle -v --path="${DOTFILES_ROOT}/Brewfile"
  ;;
esac
